name: Benchmarks

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "bot.py"
      - "config.py"
      - "tests/**"
      - ".github/workflows/benchmark.yml"
  schedule:
    - cron: "0 2 * * *" # every day at 02:00 UTC
    - cron: "0 3 * * 0" # every Sunday at 03:00 UTC

permissions:
  contents: read
  pull-requests: write

jobs:
  benchmark:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set P95 threshold by branch
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "BENCH_P95_THRESHOLD_SEC=1.2" >> $GITHUB_ENV
          else
            echo "BENCH_P95_THRESHOLD_SEC=1.6" >> $GITHUB_ENV
          fi

      - name: Run benchmark tests
        env:
          RUN_BENCHMARKS: "true"
          BENCH_P95_THRESHOLD_SEC: ${{ env.BENCH_P95_THRESHOLD_SEC }}
          BENCH_OUTPUT_PATH: "benchmarks/admin_list.json"
          BENCH_CSV_OUTPUT_PATH: "benchmarks/timeseries.csv"
        run: |
          mkdir -p benchmarks
          pytest -q tests/test_admin_benchmark.py | tee benchmarks/pytest.log

      - name: Upload benchmark artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: admin-benchmark
          path: |
            benchmarks/admin_list.json
            benchmarks/pytest.log
          if-no-files-found: warn

      - name: Comment P95 on PR
        if: ${{ github.event_name == 'pull_request' && always() }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'benchmarks/admin_list.json';
            if (fs.existsSync(path)) {
              const data = JSON.parse(fs.readFileSync(path, 'utf8'));
              const body = `Admin list benchmark:\n- runs: ${data.runs_count}\n- mean: ${data.mean_sec.toFixed(3)}s\n- median: ${data.median_sec.toFixed(3)}s\n- p95: ${data.p95_sec.toFixed(3)}s\n- max: ${data.max_sec.toFixed(3)}s\n- threshold: ${data.threshold_sec.toFixed(3)}s`;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
      - name: Notify Slack on threshold failure
        if: ${{ failure() && env.SLACK_WEBHOOK_URL != '' }}
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "Benchmarks failed on ${{ github.ref }} (p95 exceeded threshold). See artifacts: admin-benchmark. PR: ${{ github.event_name == 'pull_request' && github.event.pull_request.html_url || format('{0}/{1}/actions/runs/{2}', github.server_url, github.repository, github.run_id) }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
